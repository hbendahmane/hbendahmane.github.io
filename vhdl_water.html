<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VHDL – Water Treatment Controller - Hamza Bendahmane</title>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Merriweather', serif;
  margin: 0;
  padding: 0;
  color: #ffffff;
  overflow-x: hidden;
  background-color: #0a1f44;
}
.container { display: flex; min-height: 100vh; }
.sidebar {
  width: 25%; min-width: 220px;
  background: url("earth-11595(1).jpg") no-repeat center center;
  background-size: cover;
  position: fixed; top: 0; right: -25%;
  height: 100%; padding: 20px;
  box-sizing: border-box; transition: right 1s ease-in-out;
  color: #ffffff; display: flex; flex-direction: column; justify-content: flex-start; z-index: 2;
}
.sidebar::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.55); z-index: -1; }
.sidebar.active { right:0; }
.sidebar h1 { font-size:2.2em; margin-bottom:8px; }
.sidebar h2 { font-size:1em; margin-bottom:20px; font-weight:400; }
.sidebar blockquote { font-style: italic; font-size:1em; line-height:1.4; margin-bottom:20px; color:#ffffff; }
.sidebar nav { display:flex; flex-direction:column; }
.sidebar nav a { margin-bottom:10px; text-decoration:none; color:#ffffff; font-weight:bold; font-size:0.95em; }
.sidebar nav a.current { opacity:0.5; pointer-events:none; }
.sidebar nav a:hover:not(.current) { text-decoration:underline; }
.content { margin-right:25%; width:75%; padding:60px 40px; opacity:0; transition:opacity 1s ease-in-out; min-height:100vh; box-sizing:border-box; }
.content.active { opacity:1; }
.back-link { font-weight: 700; color: #ffffff; text-decoration: none; display: inline-block; margin-bottom: 20px; }
.back-link::before { content: "← "; }
h1.page-title { font-size:2em; margin-bottom:6px; }
h2.section-title { font-size:1.3em; margin-top:30px; margin-bottom:10px; color:#ffffff; }
p.section-text { font-size:1em; line-height:1.8; margin-bottom:20px; color:#ffffff; }
.terminal-header { background-color: #1c1c1c; padding: 8px 12px; font-size: 0.95em; font-weight: bold; border-top-left-radius: 6px; border-top-right-radius: 6px; border-bottom: 1px solid #333; margin-top:20px; }
.terminal-block { background-color: #0d0d0d; padding: 18px; font-family: Consolas, Menlo, monospace; font-size: 0.95em; line-height:1.5; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; white-space: pre; overflow-x: auto; margin-top:10px; }
sup a { font-size:0.95em; font-family: inherit; vertical-align: super; color: #ffffff; text-decoration: none; }
sup a:hover { text-decoration: underline; }
.footnotes { margin-top:28px; padding-top:18px; border-top:1px solid rgba(255,255,255,0.06); color:#cfcfcf; font-size:0.95em; line-height:1.5; }
.footnotes p { margin:10px 0; }
.footnotes a { color:#ffffff; text-decoration:none; }
.footnotes a::after { content:" ↗"; font-size:0.85em; opacity:0.9; margin-left:4px; }
.spaced-list li {
  margin-bottom: 28px;
  line-height: 1.9;
}

</style>
</head>
<body>
<div class="container">

  <div class="content" id="content">
    <a href="code.html" class="back-link">Back to Code and Software Demo</a>
    <h1 class="page-title">VHDL – Water Treatment Controller</h1>

    <h2 class="section-title">Goal</h2>
    <p class="section-text">
      The goal of this project is to design a Water Treatment Controller that monitors real-time water quality using turbidity, pH, chlorine, and flow rate sensors.  

      The system generates multi-level alerts (Normal, Level 1, Level 2, Level 3) based on an internal water quality score computed from the sensor readings.  

      This project demonstrates the ability to design modular, robust VHDL architectures suitable for industrial water monitoring, with configurable thresholds for proactive safety management.
    </p>

    <h2 class="section-title">Engineering Approach and Tools</h2>
    <p class="section-text">
      The system is implemented in VHDL, simulated using GHDL. Sensor inputs and control outputs are modeled with std_logic_vector signals, and score calculations are handled using unsigned arithmetic to avoid overflow.  

      The design consists of three main processes:
    </p>
    <ul class="section-text spaced-list">
  <li>
    <b>Quality Score Calculation:</b><br>
    A combinational process sums the most significant bits of the sensor readings to compute an internal water quality score.
  </li>
   
  <li>
    <b>Alert Detection:</b><br>
    Another combinational process translates the score into a 2-bit alert level, representing Normal, Level 1, Level 2, and Level 3 conditions.
  </li>

  <li>
    <b>Synchronous Control Outputs:</b><br>
    A clocked process updates outputs such as coagulant_dose, chlorine_dose, pump_speed, and filter_backwash, and also reports the score and alert level during simulation for verification.
  </li>
</ul>

    </ul>
    <p class="section-text">
      The testbench applies realistic sensor values representing normal conditions, Level 1, Level 2, Level 3 alerts, and a recovery scenario, ending with a controlled assert false statement to mark the simulation end.
    </p>

    <h2 class="section-title">Execution Behavior and Output Interpretation</h2>
    <p class="section-text">
      Simulation confirms correct functionality:
    </p>
    <ul class="section-text spaced-list">
  <li>
    The internal quality scores correspond to expectations: 31 (Normal), 65 (Level 1), 276–285 (Level 2), and 21 (Normal after recovery).
  </li>

  <li>
    Alert levels are triggered correctly according to thresholds: Level 2 activates when the score exceeds 225. Level 3 is ready to trigger if scores exceed 300.
  </li>

  <li>
    Control outputs (filter_backwash, pump_speed, coagulant_dose, chlorine_dose) respond accurately to the alert level and sensor inputs.
  </li>

  <li>
    Simulation log clearly reports the score and alert level at each step, making verification straightforward and suitable for professional portfolio documentation.
  </li>
</ul>

    </ul>
    <p class="section-text">
      The simulation ends intentionally with END OF SIMULATION, which is standard in GHDL and indicates controlled termination rather than an error.
    </p>


    <h2 class="section-title">Code Cells</h2>

    <div class="terminal-header">design.vhd</div>
    <div class="terminal-block">
--Author: Hamza Bendahmane
      
library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity WaterTreatmentController is
    generic (
        NUM_PROCESS_UNITS : integer := 8;
        SENSOR_DATA_WIDTH : integer := 16;
        CONTROL_PRECISION : integer := 12
    );
    port (
        clk : in std_logic;
        reset_n : in std_logic;

        -- Sensor inputs
        turbidity_sensor : in std_logic_vector(SENSOR_DATA_WIDTH-1 downto 0);
        ph_sensor        : in std_logic_vector(SENSOR_DATA_WIDTH-1 downto 0);
        chlorine_sensor  : in std_logic_vector(SENSOR_DATA_WIDTH-1 downto 0);
        flow_rate_sensor : in std_logic_vector(SENSOR_DATA_WIDTH-1 downto 0);

        -- Control outputs
        coagulant_dose      : out std_logic_vector(CONTROL_PRECISION-1 downto 0);
        chlorine_dose       : out std_logic_vector(CONTROL_PRECISION-1 downto 0);
        filter_backwash     : out std_logic;
        pump_speed          : out std_logic_vector(7 downto 0);

        -- System status - Now with 2 bits for alert levels
        water_quality_alert : out std_logic_vector(1 downto 0);  -- 00: Normal, 01: Level 1, 10: Level 2, 11: Level 3
        system_efficiency   : out std_logic_vector(7 downto 0);
        energy_consumption  : out std_logic_vector(15 downto 0)
    );
end entity;

architecture AdvancedControl of WaterTreatmentController is
    -- 10-bit to avoid overflow
    signal internal_quality_score : unsigned(9 downto 0) := (others => '0');
    
    -- Alert threshold constants (based on industrial standards)
    constant ALERT_LEVEL1_THRESHOLD : integer := 125;  -- Enhanced monitoring
    constant ALERT_LEVEL2_THRESHOLD : integer := 225;  -- Corrective action
    constant ALERT_LEVEL3_THRESHOLD : integer := 300;  -- Emergency shutdown
    
    -- Internal signal for alert level to use in case statement
    signal alert_level_internal : std_logic_vector(1 downto 0);
    
begin
    -- COMBINATORIAL PROCESS for quality score (IMMEDIATE)
    quality_calc: process(turbidity_sensor, ph_sensor, chlorine_sensor)
    begin
        internal_quality_score <=
            resize(unsigned(turbidity_sensor(15 downto 8)), 10) +
            resize(unsigned(ph_sensor(15 downto 8)), 10) +
            resize(unsigned(chlorine_sensor(15 downto 8)), 10);
    end process;
    
    -- COMBINATORIAL PROCESS for alert detection (IMMEDIATE)
    alert_detection: process(internal_quality_score)
    begin
        if internal_quality_score >= ALERT_LEVEL3_THRESHOLD then
            alert_level_internal <= "11";  -- Level 3: Critical alert
        elsif internal_quality_score >= ALERT_LEVEL2_THRESHOLD then
            alert_level_internal <= "10";  -- Level 2: High alert
        elsif internal_quality_score >= ALERT_LEVEL1_THRESHOLD then
            alert_level_internal <= "01";  -- Level 1: Early warning
        else
            alert_level_internal <= "00";  -- Normal level
        end if;
    end process;

    -- CLOCKED PROCESS (only for registered outputs)
    main_process: process(clk, reset_n)
    begin
        if reset_n = '0' then
            coagulant_dose      <= (others => '0');
            chlorine_dose       <= (others => '0');
            pump_speed          <= (others => '0');
            filter_backwash     <= '0';
            system_efficiency   <= (others => '0');
            energy_consumption  <= (others => '0');

        elsif rising_edge(clk) then
            -- Control outputs scaled
            coagulant_dose <= std_logic_vector(resize(unsigned(turbidity_sensor(11 downto 0)), CONTROL_PRECISION));
            chlorine_dose  <= std_logic_vector(resize(unsigned(chlorine_sensor(11 downto 0)), CONTROL_PRECISION));
            pump_speed     <= std_logic_vector(unsigned(flow_rate_sensor(15 downto 8)));

            -- Filter backwash based on current alert level (IMMEDIATE)
            if alert_level_internal >= "10" then  -- Level 2 or 3
                filter_backwash <= '1';
            else
                filter_backwash <= '0';
            end if;

            -- Connect internal signal to output port
            water_quality_alert <= alert_level_internal;

            -- System efficiency and energy (demo scaling)
            system_efficiency <= std_logic_vector(to_unsigned(255,8) - unsigned(flow_rate_sensor(15 downto 8)));
            energy_consumption <= std_logic_vector(resize(unsigned(flow_rate_sensor),16));

            -- Debug print for simulation with alert levels
            case alert_level_internal is
                when "00" => 
                    report "Score=" & integer'image(to_integer(internal_quality_score)) & " | NORMAL";
                when "01" => 
                    report "Score=" & integer'image(to_integer(internal_quality_score)) & " | ALERT LEVEL 1 - Monitoring";
                when "10" => 
                    report "Score=" & integer'image(to_integer(internal_quality_score)) & " | ALERT LEVEL 2 - Corrective action";
                when "11" => 
                    report "Score=" & integer'image(to_integer(internal_quality_score)) & " | ALERT LEVEL 3 - CRITICAL";
                when others => 
                    report "Score=" & integer'image(to_integer(internal_quality_score)) & " | UNKNOWN STATE";
            end case;
        end if;
    end process;
end architecture;
    </div>

    <div class="terminal-header">testbench.vhd</div>
    <div class="terminal-block">
-- --Author: Hamza Bendahmane
      
-- Multi-level alerts triggered by water quality

library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity tb_WaterTreatmentController is
end entity;

architecture sim of tb_WaterTreatmentController is
    signal clk : std_logic := '0';
    signal reset_n : std_logic := '0';

    signal turbidity_sensor, ph_sensor, chlorine_sensor, flow_rate_sensor : std_logic_vector(15 downto 0);
    signal coagulant_dose, chlorine_dose : std_logic_vector(11 downto 0);
    signal filter_backwash : std_logic;
    signal pump_speed : std_logic_vector(7 downto 0);
    signal water_quality_alert : std_logic_vector(1 downto 0);  -- Changed to 2 bits
    signal system_efficiency : std_logic_vector(7 downto 0);
    signal energy_consumption : std_logic_vector(15 downto 0);
begin
    clk <= not clk after 10 ns;

    UUT: entity work.WaterTreatmentController
        port map(
            clk => clk,
            reset_n => reset_n,
            turbidity_sensor => turbidity_sensor,
            ph_sensor => ph_sensor,
            chlorine_sensor => chlorine_sensor,
            flow_rate_sensor => flow_rate_sensor,
            coagulant_dose => coagulant_dose,
            chlorine_dose => chlorine_dose,
            filter_backwash => filter_backwash,
            pump_speed => pump_speed,
            water_quality_alert => water_quality_alert,
            system_efficiency => system_efficiency,
            energy_consumption => energy_consumption
        );

    stimulus: process
    begin
        reset_n <= '0';
        wait for 50 ns;
        reset_n <= '1';

        -- Normal water (Score ~31)
        turbidity_sensor <= x"1000"; ph_sensor <= x"0700"; chlorine_sensor <= x"0800"; flow_rate_sensor <= x"4000";
        wait for 100 ns;

        -- Level 1 Alert (Score ~65)
        turbidity_sensor <= x"3000"; ph_sensor <= x"0800"; chlorine_sensor <= x"0900"; flow_rate_sensor <= x"5000";
        wait for 100 ns;

        -- Level 2 Alert (Score ~276)
        turbidity_sensor <= x"FF00"; ph_sensor <= x"0A00"; chlorine_sensor <= x"0B00"; flow_rate_sensor <= x"6000";
        wait for 100 ns;

        -- Level 3 Alert (Need higher values - Score >300)
        turbidity_sensor <= x"FF80"; ph_sensor <= x"0F00"; chlorine_sensor <= x"0F00"; flow_rate_sensor <= x"7000";
        wait for 100 ns;

        -- Recovery to normal
        turbidity_sensor <= x"0800"; ph_sensor <= x"0700"; chlorine_sensor <= x"0600"; flow_rate_sensor <= x"4000";
        wait for 100 ns;

        assert false report "END OF SIMULATION" severity failure;
        wait;
    end process;
end architecture;
    </div>

  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h1>Hamza Bendahmane</h1>
    <h2>French state-accredited Engineer (CTI) – Diplôme d’Ingénieur, MSc</h2>
    <blockquote>“Excellence, fighting spirit, and tenacity to tackle the world’s engineering challenges.”</blockquote>
    <nav>
      <a href="about.html">About</a>
      <a href="education.html">Education</a>
      <a href="skills.html">Key Skills</a>
      <a href="professional.html">Professionnal Experiences</a>
      <a class="current" href="#">Code &amp; Software Demo</a>
      <a href="publications.html">Publications</a>
      <a href="contact.html">Contact &amp; Legal Notices</a>
    </nav>
  </div>

</div>

<script>
window.addEventListener('load', () => {
  const sidebar = document.getElementById('sidebar');
  const content = document.getElementById('content');
  content.classList.add('active');
  if (!sessionStorage.getItem('visitedHome')) {
    sidebar.classList.add('active');
    sessionStorage.setItem('visitedHome', 'true');
  } else { sidebar.style.right='0'; }
});
</script>

</body>
</html>
